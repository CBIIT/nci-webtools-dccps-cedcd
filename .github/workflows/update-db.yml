name: Run Database Update
on:
  workflow_dispatch:
    inputs:
      tier:
        description: "Deployment Tier"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod
      db_script:
        description: "db script file name (optional)"
        required: false
        default: ""
        type: string

permissions:
  contents: "read"
  id-token: "write"

jobs:
  update-database:
    runs-on: ubuntu-latest
    environment: ${{ inputs.tier }}
    env:
      APP: cedcd
      AWS_REGION: us-east-1
      TIER: ${{ inputs.tier }}
      CICD_ROLE_ARN: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-cicd

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ env.CICD_ROLE_ARN }}
          role-session-name: ${{ env.TIER }}-cedcd-update-db-${{ github.ref_name }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Retrieve SSM parameters
        run: |
          PARAMETER_PATH="/analysistools/${TIER}/${APP}"

          # Define parameters to retrieve (SSM name = ENV_VAR_NAME)
          declare -A PARAMS=(
            ["data_import_task"]="ECS_DATA_IMPORT_TASK"
            ["ecs_cluster"]="ECS_CLUSTER"
            ["subnet_ids"]="SUBNET_IDS"
            ["security_group_ids"]="SECURITY_GROUP_IDS"
          )

          # Retrieve each parameter and export to environment
          for ssm_name in "${!PARAMS[@]}"; do
            env_var="${PARAMS[$ssm_name]}"
            value=$(aws ssm get-parameter \
              --name "${PARAMETER_PATH}/${ssm_name}" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text 2>/dev/null || echo "")
            
            if [ -n "$value" ]; then
              echo "${env_var}=${value}" >> $GITHUB_ENV
              echo "Retrieved ${ssm_name} -> ${env_var}"
            else
              echo "::warning::Parameter ${PARAMETER_PATH}/${ssm_name} not found, using default or skipping"
            fi
          done

      - name: Run database update task
        id: run-task
        run: |
          # Build the command override if a specific script is provided
          OVERRIDES='{"containerOverrides":[]}'
          if [ -n "${{ inputs.db_script }}" ]; then
            echo "Running with specific script: deploy_scripts/${{ inputs.db_script }}"
            OVERRIDES='{"containerOverrides":[{"name":"data_import","command":["node","import.js","deploy_scripts/${{ inputs.db_script }}"]}]}'
          else
            echo "Running default database update (stored procedures and views only)"
            OVERRIDES='{"containerOverrides":[{"name":"data_import","command":["node","import.js"]}]}'
          fi

          echo "Launching ECS Fargate task..."
          TASK_ARN=$(aws ecs run-task \
            --cluster ${ECS_CLUSTER} \
            --count 1 \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${SUBNET_IDS}],securityGroups=[${SECURITY_GROUP_IDS}]}" \
            --task-definition ${ECS_DATA_IMPORT_TASK} \
            --overrides "${OVERRIDES}" \
            --query 'tasks[0].taskArn' \
            --output text)
